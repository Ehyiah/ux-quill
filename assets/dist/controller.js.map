{"version":3,"file":"controller.js","names":["Controller","Quill","mergeModules","axios","ImageUploader","register","Emoji","QuillResizeImage","Image","import","oldFormats","formats","domNode","hasAttribute","style","getAttribute","prototype","format","name","value","setAttribute","removeAttribute","_Class","connect","toolbarOptionsValue","modulesOptions","extraOptionsValue","modules","enabledModules","mergedModules","options","debug","placeholder","theme","upload_handler","path","type","Object","assign","imageUploader","upload","file","Promise","resolve","reject","formData","FormData","append","post","then","response","setTimeout","imgs","quill","root","querySelectorAll","forEach","img","src","startsWith","blot","find","remove","data","catch","err","console","log","reader","fileReader","FileReader","onload","result","readAsDataURL","headers","heightDefined","height","editorContainerTarget","dispatchEvent","on","quillContent","innerHTML","inputContent","inputTarget","payload","dispatch","detail","prefix","targets","values","toolbarOptions","Array","default","extraOptions"],"sources":["../src/controller.ts"],"sourcesContent":["import { Controller } from '@hotwired/stimulus';\nimport Quill from 'quill';\nimport * as Options from 'quill/core/quill';\nimport { EmojiModule, ExtraOptions, ModuleInterface, ResizeModule, uploadOptions } from './typesmodules.d.ts';\nimport mergeModules from './modules.ts';\n\nimport axios from 'axios';\n\nimport ImageUploader from './imageUploader.js'\nQuill.register('modules/imageUploader', ImageUploader);\n\nimport * as Emoji from 'quill2-emoji';\nimport 'quill2-emoji/dist/style.css';\nQuill.register('modules/emoji', Emoji);\n\nimport QuillResizeImage from 'quill-resize-image';\nQuill.register('modules/resize', QuillResizeImage);\n// allow image resize and position to be reloaded after persist\nconst Image = Quill.import('formats/image');\nconst oldFormats = Image.formats;\nImage.formats = function (domNode) {\n    const formats = oldFormats(domNode);\n    if (domNode.hasAttribute('style')) {\n        formats.style = domNode.getAttribute('style');\n    }\n    return formats;\n}\n\nImage.prototype.format = function (name, value) {\n    if (value) {\n        this.domNode.setAttribute(name, value);\n    } else {\n        this.domNode.removeAttribute(name);\n    }\n}\n\nexport default class extends Controller {\n    declare readonly inputTarget: HTMLInputElement;\n    declare readonly editorContainerTarget: HTMLDivElement;\n    static targets = ['input', 'editorContainer'];\n\n    declare readonly extraOptionsValue: ExtraOptions;\n    declare readonly toolbarOptionsValue: HTMLDivElement;\n    static values = {\n        toolbarOptions: {\n            type: Array,\n            default: [],\n        },\n        extraOptions: {\n            type: Object,\n            default: {},\n        }\n    }\n\n    connect() {\n        const toolbarOptionsValue = this.toolbarOptionsValue;\n        const modulesOptions = this.extraOptionsValue.modules;\n\n        const enabledModules = {\n            'toolbar': toolbarOptionsValue,\n        };\n\n        const mergedModules = mergeModules(modulesOptions, enabledModules);\n\n        const options: Options = {\n            debug: this.extraOptionsValue.debug,\n            modules: mergedModules,\n            placeholder: this.extraOptionsValue.placeholder,\n            theme: this.extraOptionsValue.theme,\n            style: this.extraOptionsValue.style,\n        };\n\n        if (options.style === 'inline') {\n            Quill.register(Quill.import('attributors/style/align'), true);\n            Quill.register(Quill.import('attributors/style/background'),true);\n            Quill.register(Quill.import('attributors/style/color'), true);\n            Quill.register(Quill.import('attributors/style/direction'),true);\n            Quill.register(Quill.import('attributors/style/font'), true);\n            Quill.register(Quill.import('attributors/style/size'), true);\n        }\n\n        if (this.extraOptionsValue.upload_handler.path !== null && this.extraOptionsValue.upload_handler.type === 'form') {\n            Object.assign(options.modules, {\n                imageUploader: {\n                    upload: file => {\n                        return new Promise((resolve, reject) => {\n                            const formData = new FormData();\n                            formData.append('file', file);\n\n                            axios\n                                .post(this.extraOptionsValue.upload_handler.path, formData)\n                                .then(response => {\n                                    setTimeout(() => {\n                                        const imgs = this.quill.root.querySelectorAll('img');\n                                        imgs.forEach(img => {\n                                            if (img.src.startsWith('data:')) {\n                                                const blot = Quill.find(img);\n                                                blot.remove();\n                                            }\n                                        });\n                                    }, 100);\n                                    resolve(response.data);\n                                })\n                                .catch(err => {\n                                    reject('Upload failed');\n                                    console.log(err)\n                                })\n                        })\n                    }\n                }}\n            )\n        }\n\n        if (this.extraOptionsValue.upload_handler.path !== null && this.extraOptionsValue.upload_handler.type === 'json') {\n            Object.assign(options.modules, {\n                imageUploader: {\n                    upload: file => {\n                        return new Promise((resolve, reject) => {\n                            const reader = (file) => {\n                                return new Promise((resolve) => {\n                                    const fileReader = new FileReader();\n                                    fileReader.onload = () => resolve(fileReader.result);\n                                    fileReader.readAsDataURL(file);\n                                });\n                            }\n\n                            reader(file).then(result =>\n                                axios\n                                    .post(this.extraOptionsValue.upload_handler.path, result, {\n                                        headers: {\n                                            'Content-Type': 'application/json',\n                                        }\n                                    })\n                                    .then(response => {\n                                        setTimeout(() => {\n                                            const imgs = this.quill.root.querySelectorAll('img');\n                                            imgs.forEach(img => {\n                                                if (img.src.startsWith('data:')) {\n                                                    const blot = Quill.find(img);\n                                                    blot.remove();\n                                                }\n                                            });\n                                        }, 100);\n                                        resolve(response.data);\n                                    })\n                                    .catch(err => {\n                                        reject('Upload failed');\n                                        console.log(err)\n                                    })\n                            );\n                        })\n                    }\n                }}\n            )\n        }\n\n        const heightDefined = this.extraOptionsValue.height;\n        if (null !== heightDefined) {\n            this.editorContainerTarget.style.height = heightDefined\n        }\n\n        this.dispatchEvent('options', options);\n\n        const quill = new Quill(this.editorContainerTarget, options);\n        quill.on('text-change', () => {\n            const quillContent = quill.root.innerHTML;\n            const inputContent = this.inputTarget;\n            inputContent.value = quillContent;\n        })\n\n        this.dispatchEvent('connect', quill);\n        this.quill = quill;\n    }\n\n    private dispatchEvent(name: string, payload: any = {}) {\n        this.dispatch(name, { detail: payload, prefix: 'quill' });\n    }\n}\n"],"mappings":"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"}